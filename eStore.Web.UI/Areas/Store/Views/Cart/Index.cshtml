@model CartModel

@{
    ViewBag.Title = "Index";
}

<script id="rowTmpl" type="text/html">
    <tr>
        <td data-bind="text: Title"></td>
        <td data-bind="text: Price"></td>
        <td data-bind="text: Count"></td>
        <td><a href="#" class="delItem" data-bind="click: $parent.delItem"><span class="glyphicon glyphicon-remove"></span></a>
        </td>
    </tr>
</script>

<div class="page-header">
    <h1>Cart <small>hah</small></h1>
</div>

<div class="button-group">
    <button class="btn btn-primary" data-bind="click: reload">Reload</button>
    <a class="btn btn-default" data-bind="attr: {href: returnUrl}" title="Continue shopping from the last visited place in our story">Continue</a>
    @Html.ActionLink("Checkout", "Index", "Checkout", new {area = "store"}, new {@class = "btn btn-default"})
</div>
<br>
<div class="well">
    <table class="table table-condensed">
        <thead>
            <tr>
                <th>Title</th>
                <th>Price</th>
                <th>Count</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <!-- ko foreach: items -->
            <tr>
                <td data-bind="text: Title"></td>
                <td data-bind="text: Price"></td>
                <td data-bind="text: Count"></td>
                <td><a href="#" class="delItem" data-bind="click: $parent.delItem"><span class="glyphicon glyphicon-remove"></span></a>
                </td>
            </tr>
            <!-- /ko -->
            <tr>
                <td>Total:</td>
                <td></td>
                <td data-bind="text: total"></td>
            </tr>
        </tbody>

    </table>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jqueryval")
    @Scripts.Render("~/bundles/knockout")

    <script>
        
        var CartViewModel = function (model) {
            
            this.items = ko.observableArray(model.Items);
            this.returnUrl = ko.observable(model.ReturnUrl);

            this.delItem = function (itemId, event) {
                var data = ko.toJS(itemId);
                var item = ko.dataFor(itemId);
                console.log("ww", data);
                $.ajax({
                    url: '@Url.HttpRouteUrl("DefaultApi", new {controller = "Cart", action = "Delete", id = "-ID"})'.replace('-ID', data.CartItemId),
                    type: 'Delete',
                    data: data,
                    context: this,
                    success: function (data) {
                        if (data.success) {
                            this.items.pop();
                        }
                    }
                });
            }.bind(this);

            this.reload = function () {
                $.ajax({
                    url: '@Url.HttpRouteUrl("DefaultApi", new {controller = "Cart", action = "Get"})',
                    type: 'POST',
                    context: this,
                    success: function (data) {
                        this.items(data);
                    }
                });
            }.bind(this);

            this.total = ko.computed(function () {
                var total = 0;
                for (var k = 0; k < this.items().length; ++k) {
                    total += this.items()[k].Count * this.items()[k].Price;
                }
                return total;
            }, this);
        };

        var vm = new CartViewModel(@Html.ToJSON(Model));
        ko.setTemplateEngine(new ko.nativeTemplateEngine());
        ko.applyBindings(vm);
    </script>
}

<div id="admin-options" data-bind="text: ko.toJSON($data)">
    
</div>
